<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dockfra Dashboard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--bg2:#1a1d27;--bg3:#232638;
  --text:#e8eaf6;--muted:#8892b0;--accent:#7c83f5;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;--blue:#60a5fa;
  --border:#2d3154;--radius:10px;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}

header{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:16px;flex-shrink:0}
.logo{font-size:1.2rem;font-weight:700;color:var(--accent)}
nav{display:flex;gap:4px;margin-left:8px}
.nav-btn{padding:5px 14px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:.83rem;text-decoration:none;transition:all .15s}
.nav-btn:hover,.nav-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.refresh-btn{margin-left:auto;padding:5px 14px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer;font-size:.83rem}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent)}
.auto-label{font-size:.78rem;color:var(--muted);display:flex;align-items:center;gap:6px}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.content{flex:1;overflow:hidden;display:flex;flex-direction:column;padding:16px;gap:16px}

/* tabs */
.tab-content{display:none;flex:1;overflow:hidden}
.tab-content.active{display:flex;flex-direction:column;gap:12px}

/* containers grid */
.containers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;overflow-y:auto;max-height:340px}
.container-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;cursor:pointer;transition:border-color .15s}
.container-card:hover{border-color:var(--accent)}
.container-card.selected{border-color:var(--accent);background:var(--bg3)}
.cc-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.cc-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.cc-dot.up{background:var(--green)}
.cc-dot.down{background:var(--red)}
.cc-name{font-weight:600;font-size:.9rem;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cc-status{font-size:.75rem;color:var(--muted)}
.cc-ports{font-size:.72rem;color:var(--blue);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stack-badge{font-size:.65rem;padding:1px 6px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-left:auto;flex-shrink:0}

/* log viewer */
.log-viewer{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:0}
.log-header{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:.8rem;color:var(--muted);flex-shrink:0}
.log-header span{font-weight:600;color:var(--text)}
.log-output{flex:1;overflow-y:auto;padding:10px 14px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.75rem;color:#86efac;line-height:1.7;white-space:pre-wrap;word-break:break-all}
.log-line.err{color:var(--red)}
.log-line.warn{color:var(--yellow)}

/* events table */
.events-table{width:100%;border-collapse:collapse;font-size:.82rem}
.events-table th{text-align:left;padding:6px 10px;color:var(--muted);font-weight:500;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg)}
.events-table td{padding:6px 10px;border-bottom:1px solid var(--border)}
.events-table tr:hover td{background:var(--bg2)}
.ev-level{padding:1px 8px;border-radius:999px;font-size:.72rem;font-weight:600}
.ev-level.INFO{background:#1d4ed8;color:#bfdbfe}
.ev-level.WARN{background:#92400e;color:#fde68a}
.ev-level.ERROR{background:#7f1d1d;color:#fca5a5}
.ev-level.ACTION{background:#14532d;color:#bbf7d0}
.events-wrap{flex:1;overflow-y:auto;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius)}

/* summary bar */
.summary{display:flex;gap:12px;flex-shrink:0}
.summary-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;display:flex;flex-direction:column;gap:2px;min-width:100px}
.summary-card .num{font-size:1.5rem;font-weight:700}
.summary-card .lbl{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.num.green{color:var(--green)} .num.red{color:var(--red)} .num.yellow{color:var(--yellow)} .num.blue{color:var(--blue)}

/* scrollbars */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

.empty{color:var(--muted);font-size:.85rem;padding:20px;text-align:center}
</style>
</head>
<body>

<header>
  <div class="logo">üèó Dockfra</div>
  <nav>
    <a class="nav-btn active" href="#" onclick="showTab('containers',this)">üì¶ Kontenery</a>
    <a class="nav-btn" href="#" onclick="showTab('logs',this)">üìã Logi</a>
    <a class="nav-btn" href="#" onclick="showTab('events',this)">üß† Decyzje</a>
    <a class="nav-btn" href="/" target="_blank">üßô Wizard</a>
  </nav>
  <button class="refresh-btn" onclick="refresh()">‚ü≥ Od≈õwie≈º</button>
  <div class="auto-label"><div class="dot"></div> Auto-refresh 5s</div>
</header>

<div class="content">

  <!-- CONTAINERS TAB -->
  <div id="tab-containers" class="tab-content active">
    <div id="summary" class="summary"></div>
    <div id="containers" class="containers-grid"></div>
  </div>

  <!-- LOGS TAB -->
  <div id="tab-logs" class="tab-content">
    <div id="log-viewer" class="log-viewer">
      <div class="log-header">
        <span id="log-title">Wybierz kontener</span>
        <select id="container-select" style="margin-left:auto;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:5px;padding:3px 8px;font-size:.8rem" onchange="loadLogs(this.value)">
          <option value="">‚Äî wybierz ‚Äî</option>
        </select>
        <button class="refresh-btn" onclick="loadLogs(document.getElementById('container-select').value)">‚ü≥</button>
      </div>
      <div id="log-output" class="log-output"><div class="empty">Wybierz kontener z listy powy≈ºej</div></div>
    </div>
  </div>

  <!-- EVENTS TAB -->
  <div id="tab-events" class="tab-content">
    <div class="events-wrap">
      <table class="events-table">
        <thead><tr>
          <th style="width:160px">Czas</th>
          <th style="width:80px">Poziom</th>
          <th style="width:120px">Us≈Çuga</th>
          <th>Wiadomo≈õƒá</th>
        </tr></thead>
        <tbody id="events-body"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
let selectedContainer = null;
let allContainers = [];

function showTab(name, btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='logs') refreshContainerSelect();
  if(name==='events') loadEvents();
  return false;
}

async function refresh(){
  await loadContainers();
}

async function loadContainers(){
  try{
    const r = await fetch('/api/containers');
    allContainers = await r.json();
  }catch(e){ allContainers = []; }

  const up   = allContainers.filter(c=>c.status.includes('Up')).length;
  const down = allContainers.length - up;
  const stacks = [...new Set(allContainers.map(c=>{
    if(c.name.includes('manager')||c.name.includes('autopilot')||c.name.includes('monitor')) return 'management';
    if(c.name.includes('rpi3')||c.name.includes('vnc')) return 'devices';
    return 'app';
  }))].length;

  document.getElementById('summary').innerHTML = `
    <div class="summary-card"><div class="num ${up>0?'green':'muted'}">${up}</div><div class="lbl">Running</div></div>
    <div class="summary-card"><div class="num ${down>0?'red':'green'}">${down}</div><div class="lbl">Stopped</div></div>
    <div class="summary-card"><div class="num blue">${allContainers.length}</div><div class="lbl">Total</div></div>
    <div class="summary-card"><div class="num yellow">${stacks}</div><div class="lbl">Stacks</div></div>`;

  const grid = document.getElementById('containers');
  if(!allContainers.length){ grid.innerHTML='<div class="empty">Brak uruchomionych kontener√≥w</div>'; return; }

  grid.innerHTML = allContainers.map(c=>{
    const isUp = c.status.includes('Up');
    const stack = c.name.includes('manager')||c.name.includes('autopilot')||c.name.includes('monitor')
      ? 'mgmt' : c.name.includes('rpi3')||c.name.includes('vnc') ? 'devices' : 'app';
    return `<div class="container-card ${c.name===selectedContainer?'selected':''}" onclick="selectContainer('${c.name}')">
      <div class="cc-header">
        <div class="cc-dot ${isUp?'up':'down'}"></div>
        <div class="cc-name">${c.name}</div>
        <div class="stack-badge">${stack}</div>
      </div>
      <div class="cc-status">${c.status}</div>
      ${c.ports?`<div class="cc-ports">üîå ${c.ports}</div>`:''}
    </div>`;
  }).join('');
}

function selectContainer(name){
  selectedContainer = name;
  loadContainers(); // re-render selection
  showTab('logs', document.querySelector('.nav-btn:nth-child(2)'));
  document.getElementById('container-select').value = name;
  loadLogs(name);
}

function refreshContainerSelect(){
  const sel = document.getElementById('container-select');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî wybierz ‚Äî</option>' +
    allContainers.map(c=>`<option value="${c.name}" ${c.name===cur?'selected':''}>${c.name}</option>`).join('');
}

async function loadLogs(container){
  if(!container) return;
  selectedContainer = container;
  document.getElementById('log-title').textContent = container;
  const out = document.getElementById('log-output');
  out.innerHTML = '<div class="empty">≈Åadowanie...</div>';
  try{
    const r = await fetch(`/api/logs/${container}`);
    const d = await r.json();
    if(!d.lines.length){ out.innerHTML='<div class="empty">Brak log√≥w</div>'; return; }
    out.innerHTML = d.lines.map(l=>{
      const cls = /error|Error|ERRO|failed|FAIL/i.test(l) ? 'err'
                : /warn|WARN/i.test(l) ? 'warn' : '';
      return `<div class="log-line ${cls}">${escHtml(l)}</div>`;
    }).join('');
    out.scrollTop = out.scrollHeight;
  }catch(e){ out.innerHTML=`<div class="empty">B≈ÇƒÖd: ${e}</div>`; }
}

async function loadEvents(){
  const tbody = document.getElementById('events-body');
  tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">≈Åadowanie...</td></tr>';
  try{
    const r = await fetch('/api/events');
    const events = await r.json();
    if(!events.length){
      tbody.innerHTML='<tr><td colspan="4"><div class="empty">Brak zdarze≈Ñ ‚Äî management us≈Çugi jeszcze nie logujƒÖ</div></td></tr>'; return;
    }
    tbody.innerHTML = events.slice().reverse().map(e=>{
      const lvl = e.level||'INFO';
      const ts  = e.timestamp ? new Date(e.timestamp).toLocaleTimeString('pl') : '';
      return `<tr>
        <td style="color:var(--muted);font-size:.78rem">${ts}</td>
        <td><span class="ev-level ${lvl}">${lvl}</span></td>
        <td style="color:var(--accent)">${escHtml(e.service||'')}</td>
        <td>${escHtml(e.message||JSON.stringify(e))}</td>
      </tr>`;
    }).join('');
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="4"><div class="empty">B≈ÇƒÖd: ${e}</div></td></tr>`;
  }
}

function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// auto-refresh
loadContainers();
setInterval(()=>{
  const activeTab = document.querySelector('.tab-content.active');
  if(!activeTab) return;
  if(activeTab.id==='tab-containers') loadContainers();
  else if(activeTab.id==='tab-events') loadEvents();
}, 5000);
</script>
</body>
</html>
