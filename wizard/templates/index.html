<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dockfra Wizard</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--bg2:#1a1d27;--bg3:#232638;
  --text:#e8eaf6;--muted:#8892b0;--accent:#7c83f5;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;
  --border:#2d3154;--radius:10px;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
header{background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px}
header .logo{font-size:1.3rem;font-weight:700;color:var(--accent)}
header .sub{color:var(--muted);font-size:.85rem}
.status-bar{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:.8rem;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

.main{display:flex;flex:1;overflow:hidden;position:relative}
.chat-panel{width:40%;display:flex;flex-direction:column;min-width:200px}
.log-panel{width:60%;min-width:200px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;position:relative}
.resize-handle{position:absolute;top:0;bottom:0;width:4px;background:transparent;cursor:col-resize;z-index:10}
.resize-handle:hover{background:var(--accent)}
.resize-handle.left{left:-2px}
.resize-handle.right{right:-2px}
.log-panel h3{padding:10px 14px;font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);border-bottom:1px solid var(--border)}
#log-output{flex:1;overflow-y:auto;padding:10px 14px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.75rem;color:#6ee7b7;line-height:1.6}
.log-line{white-space:pre-wrap;word-break:break-all}
.log-line.err{color:var(--red)}

#chat{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
#widgets{padding:0 20px 16px;display:flex;flex-direction:column;gap:10px}

/* messages */
.msg{display:flex;gap:10px;max-width:85%;animation:fadein .2s ease}
@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.bot{align-self:flex-start}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.msg.bot .avatar{background:var(--bg3);border:1px solid var(--border)}
.msg.user .avatar{background:var(--accent)}
.bubble{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:10px 14px;font-size:.9rem;line-height:1.6}
.msg.user .bubble{background:var(--accent);border-color:transparent;color:#fff}
.bubble h1{font-size:1.2rem;margin-bottom:4px;color:var(--accent)}
.bubble h2{font-size:1rem;margin-bottom:4px;color:var(--accent)}
.bubble h3{font-size:.9rem;margin-bottom:2px}
.bubble strong{color:var(--accent)}
.bubble code{background:var(--bg3);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:.85em}
.bubble pre{background:var(--bg3);border-radius:6px;padding:10px;overflow-x:auto;font-size:.8em;margin-top:6px}

/* widgets */
.w-buttons{display:flex;flex-wrap:wrap;gap:8px}
.btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer;font-size:.88rem;transition:all .15s}
.btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;transform:translateY(-1px)}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}

.w-form{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:12px}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.field input,.field select{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:8px 12px;font-size:.9rem;width:100%}
.field input:focus,.field select:focus{outline:none;border-color:var(--accent)}
.field select option{background:var(--bg3)}

.w-code{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.8rem;color:#6ee7b7;white-space:pre-wrap;word-break:break-all;max-height:300px;overflow-y:auto}

.w-status{display:flex;flex-direction:column;gap:6px}
.status-item{display:flex;align-items:center;gap:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:.85rem}
.status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.status-dot.ok{background:var(--green)}
.status-dot.err{background:var(--red)}
.status-name{font-weight:600;flex:1}
.status-detail{color:var(--muted);font-size:.78rem}

.w-progress{display:flex;align-items:center;gap:10px;padding:6px 2px;font-size:.85rem;color:var(--muted)}
.spin{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.w-progress.done{color:var(--green)}
.w-progress.done .spin{border-color:var(--green);border-top-color:var(--green);animation:none}
.w-progress.err{color:var(--red)}

/* scrollbars */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<header>
  <div class="logo">üèó Dockfra</div>
  <div class="sub">Setup Wizard</div>
  <div class="status-bar"><div class="dot"></div><span id="conn-status">Connecting...</span></div>
</header>

<div class="main">
  <div class="chat-panel" id="chat-panel">
    <div id="chat"></div>
    <div id="widgets"></div>
  </div>
  <div class="resize-handle right" id="resize-handle"></div>
  <div class="log-panel" id="log-panel">
    <h3>üìã Execution log <button id="copy-logs" style="float:right;font-size:0.7rem;padding:4px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;cursor:pointer;">üìã Copy</button></h3>
    <div id="log-output"></div>
  </div>
</div>

<script>
const chat    = document.getElementById('chat');
const widgets = document.getElementById('widgets');
const logOut  = document.getElementById('log-output');
const connEl  = document.getElementById('conn-status');

const socket = io({transports:['websocket','polling']});

socket.on('connect',    () => { connEl.textContent = 'Connected'; });
socket.on('disconnect', () => { connEl.textContent = 'Disconnected'; });

// ‚îÄ‚îÄ Markdown-lite renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMd(text){
  return text
    .replace(/^# (.+)$/gm,  '<h1>$1</h1>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g,  '<code>$1</code>')
    .replace(/\n/g, '<br>');
}

// ‚îÄ‚îÄ Load conversation history ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadHistory() {
  try {
    const response = await fetch('/api/history');
    const data = await response.json();
    
    // Clear current content
    chat.innerHTML = '';
    logOut.innerHTML = '';
    
    // Load conversation
    data.conversation.forEach(msg => {
      const div = document.createElement('div');
      div.className = `msg ${msg.role}`;
      div.setAttribute('data-msg-id', msg.id);
      div.innerHTML = `
        <div class="avatar">${msg.role==='bot'?'ü§ñ':'üë§'}</div>
        <div class="bubble">${renderMd(msg.text)}</div>`;
      chat.appendChild(div);
    });
    
    // Load logs
    data.logs.forEach(log => {
      const l = document.createElement('div');
      l.className = 'log-line' + (log.text.includes('Error')||log.text.includes('error')||log.text.startsWith('E ')?' err':'');
      l.setAttribute('data-log-id', log.id);
      l.textContent = log.text;
      logOut.appendChild(l);
    });
    
    // Scroll to bottom
    chat.scrollTop = chat.scrollHeight;
    logOut.scrollTop = logOut.scrollHeight;
  } catch (error) {
    console.error('Failed to load history:', error);
  }
}

// Load history on page load
loadHistory();

// ‚îÄ‚îÄ Message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
socket.on('message', d => {
  // Check if message already exists to prevent duplicates
  if (d.id) {
    const existingMsg = document.querySelector(`[data-msg-id="${d.id}"]`);
    if (existingMsg) return; // Skip duplicate
  }
  
  const div = document.createElement('div');
  div.className = `msg ${d.role}`;
  if (d.id) div.setAttribute('data-msg-id', d.id);
  div.innerHTML = `
    <div class="avatar">${d.role==='bot'?'ü§ñ':'üë§'}</div>
    <div class="bubble">${renderMd(d.text)}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
});

// ‚îÄ‚îÄ Widgets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
socket.on('clear_widgets', () => { widgets.innerHTML = ''; });

socket.on('widget', d => {
  if (d.type === 'buttons')    renderButtons(d);
  else if (d.type === 'input') renderInput(d);
  else if (d.type === 'select')renderSelect(d);
  else if (d.type === 'code')  renderCode(d);
  else if (d.type === 'status_row') renderStatus(d);
  else if (d.type === 'progress')   renderProgress(d);
});

// Collect all form field values from current widgets
function collectForm(){
  const form = {};
  widgets.querySelectorAll('input[data-name]').forEach(el => {
    form[el.dataset.name] = el.value;
  });
  widgets.querySelectorAll('select[data-name]').forEach(el => {
    form[el.dataset.name] = el.value;
  });
  return form;
}

function sendAction(value){
  const form = collectForm();
  // Show user bubble
  const div = document.createElement('div');
  div.className = 'msg user';
  const label = value.replace(/^[^:]+::/,'');
  div.innerHTML = `<div class="avatar">üë§</div><div class="bubble">${label}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  socket.emit('action', {value, form});
}

function renderButtons(d){
  const wrap = document.createElement('div');
  wrap.className = 'w-buttons';
  if(d.label){ const l=document.createElement('div'); l.style.cssText='width:100%;color:var(--muted);font-size:.8rem'; l.textContent=d.label; wrap.appendChild(l); }
  d.items.forEach(item => {
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = item.label;
    b.onclick = () => sendAction(item.value);
    wrap.appendChild(b);
  });
  widgets.appendChild(wrap);
}

// Group consecutive input/select widgets into a single form
let _formBuf = null;
let _formTimer = null;

function flushForm(){
  if(!_formBuf) return;
  widgets.appendChild(_formBuf);
  _formBuf = null; _formTimer = null;
}

function getOrCreateForm(){
  if(!_formBuf){
    _formBuf = document.createElement('div');
    _formBuf.className = 'w-form';
  }
  clearTimeout(_formTimer);
  _formTimer = setTimeout(flushForm, 80);
  return _formBuf;
}

function renderInput(d){
  const form = getOrCreateForm();
  const field = document.createElement('div');
  field.className = 'field';
  field.innerHTML = `<label>${d.label}</label>`;
  const inp = document.createElement('input');
  inp.type = d.secret ? 'password' : 'text';
  inp.placeholder = d.placeholder || '';
  inp.value = d.value || '';
  inp.dataset.name = d.name;
  inp.id = 'field_'+d.name;
  field.appendChild(inp);
  form.appendChild(field);
}

function renderSelect(d){
  const form = getOrCreateForm();
  const field = document.createElement('div');
  field.className = 'field';
  field.innerHTML = `<label>${d.label}</label>`;
  const sel = document.createElement('select');
  sel.dataset.name = d.name;
  sel.id = 'field_'+d.name;
  d.options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.value; opt.textContent = o.label;
    if(o.value === d.value) opt.selected = true;
    sel.appendChild(opt);
  });
  field.appendChild(sel);
  form.appendChild(field);
}

function renderCode(d){
  const pre = document.createElement('div');
  pre.className = 'w-code';
  pre.textContent = d.text;
  widgets.appendChild(pre);
}

function renderStatus(d){
  const wrap = document.createElement('div');
  wrap.className = 'w-status';
  d.items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'status-item';
    row.innerHTML = `<div class="status-dot ${item.ok?'ok':'err'}"></div>
      <span class="status-name">${item.name}</span>
      <span class="status-detail">${item.detail||''}</span>`;
    wrap.appendChild(row);
  });
  widgets.appendChild(wrap);
}

function renderProgress(d){
  const wrap = document.createElement('div');
  wrap.className = `w-progress${d.done?' done':''}${d.error?' err':''}`;
  const icon = d.done ? '‚úÖ' : d.error ? '‚ùå' : '';
  wrap.innerHTML = d.done||d.error
    ? `<span>${icon}</span><span>${d.label}</span>`
    : `<div class="spin"></div><span>${d.label}</span>`;
  widgets.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

// ‚îÄ‚îÄ Panel resizing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const resizeHandle = document.getElementById('resize-handle');
const chatPanel = document.getElementById('chat-panel');
const logPanel = document.getElementById('log-panel');
const mainContainer = document.querySelector('.main');
let isResizing = false;
let startX = 0;
let startLogWidth = 0;

resizeHandle.addEventListener('mousedown', (e) => {
  isResizing = true;
  startX = e.clientX;
  startLogWidth = logPanel.offsetWidth;
  
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
  document.body.style.pointerEvents = 'none'; // Prevent text selection during resize
  resizeHandle.style.pointerEvents = 'auto'; // Allow handle to be clicked
  e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  
  const deltaX = e.clientX - startX;
  const containerWidth = mainContainer.offsetWidth;
  const newLogWidth = startLogWidth - deltaX;
  
  // Constrain log panel width (min 200px, max 80% of container)
  const minPanelWidth = 200;
  const maxLogWidth = containerWidth * 0.8;
  
  if (newLogWidth >= minPanelWidth && newLogWidth <= maxLogWidth) {
    logPanel.style.width = newLogWidth + 'px';
    // Chat panel automatically fills remaining space with flex: 1
  }
});

document.addEventListener('mouseup', () => {
  if (isResizing) {
    isResizing = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    document.body.style.pointerEvents = '';
    
    // Save the preferred log width to localStorage
    const logWidth = logPanel.offsetWidth;
    localStorage.setItem('dockfra-log-width', logWidth);
  }
});

// Restore saved widths on page load
function restorePanelWidths() {
  const savedLogWidth = localStorage.getItem('dockfra-log-width');
  const containerWidth = mainContainer.offsetWidth;
  
  if (savedLogWidth) {
    const logWidth = Math.min(Math.max(parseInt(savedLogWidth), 200), containerWidth * 0.8);
    logPanel.style.width = logWidth + 'px';
    // Chat panel automatically fills remaining space with flex: 1
  } else {
    // Set default 40/60 split if no saved preference
    logPanel.style.width = '60%';
    chatPanel.style.width = '40%';
  }
}

// Restore widths after page load
setTimeout(restorePanelWidths, 100);

// ‚îÄ‚îÄ Copy logs functionality ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('copy-logs').addEventListener('click', () => {
  const allLogs = Array.from(logOut.children).map(child => child.textContent).join('\n');
  const truncatedLogs = allLogs.length > 5000 ? allLogs.slice(-5000) : allLogs;
  
  navigator.clipboard.writeText(truncatedLogs).then(() => {
    const btn = document.getElementById('copy-logs');
    const originalText = btn.textContent;
    btn.textContent = '‚úÖ Copied!';
    btn.style.background = 'var(--accent)';
    btn.style.color = '#fff';
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = 'var(--bg3)';
      btn.style.color = 'var(--text)';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy logs:', err);
    const btn = document.getElementById('copy-logs');
    btn.textContent = '‚ùå Failed';
    setTimeout(() => {
      btn.textContent = 'üìã Copy';
    }, 2000);
  });
});

// ‚îÄ‚îÄ Log panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
socket.on('log_line', d => {
  // Check if log line already exists to prevent duplicates
  if (d.id) {
    const existingLog = document.querySelector(`[data-log-id="${d.id}"]`);
    if (existingLog) return; // Skip duplicate
  }
  
  const l = document.createElement('div');
  l.className = 'log-line' + (d.text.includes('Error')||d.text.includes('error')||d.text.startsWith('E ')?' err':'');
  if (d.id) l.setAttribute('data-log-id', d.id);
  l.textContent = d.text;
  logOut.appendChild(l);
  logOut.scrollTop = logOut.scrollHeight;
  // keep last 500 lines
  while(logOut.children.length > 500) logOut.removeChild(logOut.firstChild);
});
</script>
</body>
</html>
