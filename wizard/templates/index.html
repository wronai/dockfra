<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dockfra Wizard</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--bg2:#1a1d27;--bg3:#232638;
  --text:#e8eaf6;--muted:#8892b0;--accent:#7c83f5;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;
  --border:#2d3154;--radius:10px;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
header{background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px}
header .logo{font-size:1.3rem;font-weight:700;color:var(--accent)}
header .sub{color:var(--muted);font-size:.85rem}
.status-bar{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:.8rem;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

.main{display:flex;flex:1;overflow:hidden;position:relative}
.chat-panel{width:25%;display:flex;flex-direction:column;min-width:200px;position:relative}
.processes-panel{width:20%;min-width:200px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;position:relative}
.log-panel{width:55%;min-width:200px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;position:relative}
.resize-handle{position:absolute;top:0;bottom:0;width:4px;background:transparent;cursor:col-resize;z-index:10}
.resize-handle:hover{background:var(--accent)}
.resize-handle.left{left:-2px}
.resize-handle.right{right:-2px}
.processes-panel h3{padding:10px 14px;font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
#processes-list{flex:1;overflow-y:auto;padding:10px 14px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.75rem;line-height:1.6}
.process-item{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--border);position:relative}
.process-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.process-status.running{background:var(--green)}
.process-status.stopped{background:var(--red)}
.process-status.unknown{background:var(--muted)}
.process-name{font-size:.7rem;color:var(--text);flex:1}
.process-details{font-size:.65rem;color:var(--muted);margin-left:auto;margin-right:8px}
.process-actions{position:relative;display:flex;gap:4px;align-items:center}
.process-actions select{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:4px;padding:2px 6px;font-size:.6rem;cursor:pointer}
.process-actions select:focus{outline:none;border-color:var(--accent)}
.process-icon-btn{background:transparent;border:none;color:var(--text);cursor:pointer;padding:2px;font-size:.8rem;border-radius:3px;transition:all .2s;position:relative}
.process-icon-btn:hover{background:var(--bg3);color:var(--accent)}
.process-icon-btn:active{transform:scale(0.9)}
.tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:4px;font-size:.6rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;z-index:1000;margin-bottom:4px}
.tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:var(--bg2)}
.process-icon-btn:hover .tooltip{opacity:1}
.chat-header{padding:10px 14px;font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.copy-btn{font-size:0.7rem;padding:4px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;cursor:pointer;color:var(--text);transition:all .2s}
.copy-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.msg{position:relative}
.msg-copy{position:absolute;top:5px;right:5px;width:20px;height:20px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;display:none;align-items:center;justify-content:center;cursor:pointer;font-size:.7rem;opacity:0;transition:opacity .2s}
.msg:hover .msg-copy{display:flex;opacity:1}
.msg-copy:hover{background:var(--accent);color:#fff}
.log-panel h3{padding:10px 14px;font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);border-bottom:1px solid var(--border)}
#log-output{flex:1;overflow-y:auto;padding:10px 14px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.75rem;color:#6ee7b7;line-height:1.6}
.log-line{white-space:pre-wrap;word-break:break-all}
.log-line.err{color:var(--red)}

#chat{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
#widgets{padding:0 20px 16px;display:flex;flex-direction:column;gap:10px}

/* messages */
.msg{display:flex;gap:10px;max-width:85%;animation:fadein .2s ease}
@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.bot{align-self:flex-start}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.msg.bot .avatar{background:var(--bg3);border:1px solid var(--border)}
.msg.user .avatar{background:var(--accent)}
.bubble{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:10px 14px;font-size:.9rem;line-height:1.6}
.msg.user .bubble{background:var(--accent);border-color:transparent;color:#fff}
.bubble h1{font-size:1.2rem;margin-bottom:4px;color:var(--accent)}
.bubble h2{font-size:1rem;margin-bottom:4px;color:var(--accent)}
.bubble h3{font-size:.9rem;margin-bottom:2px}
.bubble strong{color:var(--accent)}
.bubble code{background:var(--bg3);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:.85em}
.bubble pre{background:var(--bg3);border-radius:6px;padding:10px;overflow-x:auto;font-size:.8em;margin-top:6px}

/* widgets */
.w-buttons{display:flex;flex-wrap:wrap;gap:8px}
.btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer;font-size:.88rem;transition:all .15s}
.btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;transform:translateY(-1px)}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}

.w-form{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:12px}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.field input,.field select{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:8px 12px;font-size:.9rem;width:100%}
.field input:focus,.field select:focus{outline:none;border-color:var(--accent)}
.field select option{background:var(--bg3)}
.field-hint{font-size:.72rem;color:var(--muted);margin-top:3px;padding-left:2px;font-style:italic}
.field-hint code{background:var(--bg3);padding:1px 4px;border-radius:3px;font-style:normal;color:var(--accent);cursor:pointer}
.field-hint code:hover{background:var(--accent);color:#fff}

.w-code{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;font-family:'Cascadia Code','Fira Code',monospace;font-size:.8rem;color:#6ee7b7;white-space:pre-wrap;word-break:break-all;max-height:300px;overflow-y:auto}

.w-status{display:flex;flex-direction:column;gap:6px}
.status-item{display:flex;align-items:center;gap:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:.85rem}
.status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.status-dot.ok{background:var(--green)}
.status-dot.err{background:var(--red)}
.status-name{font-weight:600;flex:1}
.status-detail{color:var(--muted);font-size:.78rem}

.w-progress{display:flex;align-items:center;gap:10px;padding:6px 2px;font-size:.85rem;color:var(--muted)}
.spin{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.w-progress.done{color:var(--green)}
.w-progress.done .spin{border-color:var(--green);border-top-color:var(--green);animation:none}
.w-progress.err{color:var(--red)}

/* scrollbars */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ— Dockfra</div>
  <div class="sub">Setup Wizard</div>
  <div class="status-bar">
    <div class="dot"></div><span id="conn-status">Connecting...</span>
    <select id="lang-select" style="margin-left:12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:3px 8px;font-size:.78rem;cursor:pointer">
      <option value="pl">ğŸ‡µğŸ‡± Polski</option>
      <option value="en">ğŸ‡¬ğŸ‡§ English</option>
      <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
      <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
      <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
      <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
      <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
    </select>
  </div>
</header>

<div class="main">
  <div class="chat-panel" id="chat-panel">
    <div class="chat-header">
      <span>ğŸ’¬ Chat</span>
      <button id="copy-chat" class="copy-btn">ğŸ“‹ Copy</button>
    </div>
    <div id="chat"></div>
    <div id="widgets"></div>
  </div>
  <div class="resize-handle right" id="resize-handle-chat"></div>
  <div class="processes-panel" id="processes-panel">
    <h3>
      <span>âš™ï¸ Processes</span>
      <button id="copy-processes" class="copy-btn">ğŸ“‹ Copy</button>
    </h3>
    <div id="processes-list"></div>
  </div>
  <div class="resize-handle right" id="resize-handle-logs"></div>
  <div class="log-panel" id="log-panel">
    <h3>ğŸ“‹ Execution log <button id="copy-logs" style="float:right;font-size:0.7rem;padding:4px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;cursor:pointer;">ğŸ“‹ Copy</button></h3>
    <div id="log-output"></div>
  </div>
</div>

<script>
const chat    = document.getElementById('chat');
const widgets = document.getElementById('widgets');
const logOut  = document.getElementById('log-output');
const connEl  = document.getElementById('conn-status');
const processesList = document.getElementById('processes-list');

// â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TRANSLATIONS = {
  pl:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Procesy', logs:'ğŸ“‹ Logi', copy:'ğŸ“‹ Kopiuj',
       connecting:'ÅÄ…czenie...', connected:'PoÅ‚Ä…czono', disconnected:'RozÅ‚Ä…czono', sub:'Kreator konfiguracji' },
  en:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Processes', logs:'ğŸ“‹ Logs', copy:'ğŸ“‹ Copy',
       connecting:'Connecting...', connected:'Connected', disconnected:'Disconnected', sub:'Setup Wizard' },
  de:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Prozesse', logs:'ğŸ“‹ Protokolle', copy:'ğŸ“‹ Kopieren',
       connecting:'Verbinde...', connected:'Verbunden', disconnected:'Getrennt', sub:'Einrichtungsassistent' },
  fr:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Processus', logs:'ğŸ“‹ Journaux', copy:'ğŸ“‹ Copier',
       connecting:'Connexion...', connected:'ConnectÃ©', disconnected:'DÃ©connectÃ©', sub:'Assistant de configuration' },
  es:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Procesos', logs:'ğŸ“‹ Registros', copy:'ğŸ“‹ Copiar',
       connecting:'Conectando...', connected:'Conectado', disconnected:'Desconectado', sub:'Asistente de configuraciÃ³n' },
  it:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Processi', logs:'ğŸ“‹ Log', copy:'ğŸ“‹ Copia',
       connecting:'Connessione...', connected:'Connesso', disconnected:'Disconnesso', sub:'Procedura guidata' },
  pt:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Processos', logs:'ğŸ“‹ Registos', copy:'ğŸ“‹ Copiar',
       connecting:'A ligar...', connected:'Ligado', disconnected:'Desligado', sub:'Assistente de configuraÃ§Ã£o' },
  cs:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Procesy', logs:'ğŸ“‹ Logy', copy:'ğŸ“‹ KopÃ­rovat',
       connecting:'PÅ™ipojovÃ¡nÃ­...', connected:'PÅ™ipojeno', disconnected:'Odpojeno', sub:'PrÅ¯vodce nastavenÃ­m' },
  ro:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Procese', logs:'ğŸ“‹ Jurnale', copy:'ğŸ“‹ CopiaÈ›i',
       connecting:'Se conecteazÄƒ...', connected:'Conectat', disconnected:'Deconectat', sub:'Expert configurare' },
  nl:{ chat:'ğŸ’¬ Chat', processes:'âš™ï¸ Processen', logs:'ğŸ“‹ Logboek', copy:'ğŸ“‹ KopiÃ«ren',
       connecting:'Verbinden...', connected:'Verbonden', disconnected:'Verbroken', sub:'Installatiewizard' },
};
let _lang = localStorage.getItem('wizard_lang') || 'pl';
function t(k){ return (TRANSLATIONS[_lang]||TRANSLATIONS.pl)[k]||k; }
function applyLang(){
  document.documentElement.lang = _lang;
  const sel = document.getElementById('lang-select'); if(sel) sel.value = _lang;
  const sub = document.querySelector('.sub'); if(sub) sub.textContent = t('sub');
  const ch = document.querySelector('.chat-header span'); if(ch) ch.textContent = t('chat');
  const cpChat = document.getElementById('copy-chat'); if(cpChat) cpChat.textContent = t('copy');
  const prSpan = document.querySelector('.processes-panel h3 span'); if(prSpan) prSpan.textContent = t('processes');
  const cpProc = document.querySelector('.processes-panel h3 .copy-btn'); if(cpProc) cpProc.textContent = t('copy');
  const logH = document.querySelector('.log-panel h3'); if(logH) logH.firstChild.textContent = t('logs')+' ';
}
document.getElementById('lang-select').addEventListener('change', e => {
  _lang = e.target.value; localStorage.setItem('wizard_lang', _lang); applyLang();
});
applyLang();

const socket = io({transports:['websocket','polling']});

socket.on('connect',    () => { connEl._state='connected';    connEl.textContent = t('connected'); });
socket.on('disconnect', () => { connEl._state='disconnected'; connEl.textContent = t('disconnected'); });

// â”€â”€ Markdown-lite renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMd(text){
  return text
    .replace(/^# (.+)$/gm,  '<h1>$1</h1>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g,  '<code>$1</code>')
    .replace(/\n/g, '<br>');
}

// â”€â”€ Load conversation history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// History is replayed by server on socket connect â€” no separate fetch needed.
// loadHistory() kept only for logs (no widget/message duplication risk there).
async function loadLogs() {
  try {
    const r = await fetch('/api/history');
    const d = await r.json();
    d.logs.forEach(log => {
      if(log.id && document.querySelector(`[data-log-id="${log.id}"]`)) return;
      const l = document.createElement('div');
      l.className = 'log-line' + (/error|Error/.test(log.text)||log.text.startsWith('E ')?' err':'');
      l.setAttribute('data-log-id', log.id);
      l.textContent = log.text;
      logOut.appendChild(l);
    });
    logOut.scrollTop = logOut.scrollHeight;
  } catch(e) { console.warn('loadLogs:', e); }
}

// â”€â”€ Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('message', d => {
  // Check if message already exists to prevent duplicates
  if (d.id) {
    const existingMsg = document.querySelector(`[data-msg-id="${d.id}"]`);
    if (existingMsg) return; // Skip duplicate
  }
  
  const div = document.createElement('div');
  div.className = `msg ${d.role}`;
  if (d.id) div.setAttribute('data-msg-id', d.id);
  div.innerHTML = `
    <div class="avatar">${d.role==='bot'?'ğŸ¤–':'ğŸ‘¤'}</div>
    <div class="bubble">${renderMd(d.text)}</div>
    <div class="msg-copy" onclick="copyMessage(this)" title="Copy message">ğŸ“‹</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
});

// Copy message function
function copyMessage(button) {
  const msgDiv = button.closest('.msg');
  const bubble = msgDiv.querySelector('.bubble');
  const text = bubble.textContent || bubble.innerText;
  
  navigator.clipboard.writeText(text).then(() => {
    const originalText = button.textContent;
    button.textContent = 'âœ…';
    button.style.background = 'var(--accent)';
    button.style.color = '#fff';
    
    setTimeout(() => {
      button.textContent = originalText;
      button.style.background = '';
      button.style.color = '';
    }, 1500);
  }).catch(err => {
    console.error('Failed to copy message:', err);
  });
}

// â”€â”€ Widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('clear_widgets', () => { widgets.innerHTML = ''; });

socket.on('widget', d => {
  if (d.type === 'buttons')    renderButtons(d);
  else if (d.type === 'input') renderInput(d);
  else if (d.type === 'select')renderSelect(d);
  else if (d.type === 'code')  renderCode(d);
  else if (d.type === 'status_row') renderStatus(d);
  else if (d.type === 'progress')   renderProgress(d);
});

// Collect all form field values from current widgets
function collectForm(){
  const form = {};
  widgets.querySelectorAll('input[data-name]').forEach(el => {
    form[el.dataset.name] = el.value;
  });
  widgets.querySelectorAll('select[data-name]').forEach(el => {
    form[el.dataset.name] = el.value;
  });
  return form;
}

function sendAction(value){
  const form = collectForm();
  // Show user bubble
  const div = document.createElement('div');
  div.className = 'msg user';
  const label = value.replace(/^[^:]+::/,'');
  div.innerHTML = `<div class="avatar">ğŸ‘¤</div><div class="bubble">${label}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  socket.emit('action', {value, form});
}

function renderButtons(d){
  // Replace any existing buttons row â€” never accumulate multiple
  const existing = widgets.querySelector('.w-buttons');
  if(existing) existing.remove();
  const wrap = document.createElement('div');
  wrap.className = 'w-buttons';
  if(d.label){ const l=document.createElement('div'); l.style.cssText='width:100%;color:var(--muted);font-size:.8rem;margin-bottom:4px'; l.textContent=d.label; wrap.appendChild(l); }
  d.items.forEach(item => {
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = item.label;
    b.onclick = () => sendAction(item.value);
    wrap.appendChild(b);
  });
  widgets.appendChild(wrap);
}

// Group consecutive input/select widgets into a single form
let _formBuf = null;
let _formTimer = null;

function flushForm(){
  if(!_formBuf) return;
  widgets.appendChild(_formBuf);
  _formBuf = null; _formTimer = null;
}

function getOrCreateForm(){
  if(!_formBuf){
    _formBuf = document.createElement('div');
    _formBuf.className = 'w-form';
  }
  clearTimeout(_formTimer);
  _formTimer = setTimeout(flushForm, 80);
  return _formBuf;
}

function renderInput(d){
  const form = getOrCreateForm();
  const field = document.createElement('div');
  field.className = 'field';
  field.innerHTML = `<label>${d.label}</label>`;
  const inp = document.createElement('input');
  inp.type = d.secret ? 'password' : 'text';
  inp.placeholder = d.placeholder || '';
  inp.value = d.value || '';
  inp.dataset.name = d.name;
  inp.id = 'field_'+d.name;
  field.appendChild(inp);
  if(d.hint){
    const hint = document.createElement('div');
    hint.className = 'field-hint';
    // If hint contains a value suggestion (starts with 'np.'), make it clickable
    const m = d.hint.match(/^(np\. )(.+)$/);
    if(m){
      hint.innerHTML = `${m[1]}<code title="Kliknij aby uÅ¼yÄ‡">${m[2]}</code>`;
      hint.querySelector('code').addEventListener('click', () => {
        inp.value = m[2];
        inp.type = d.secret ? 'text' : inp.type; // reveal on click
        inp.dispatchEvent(new Event('input'));
      });
    } else {
      hint.textContent = d.hint;
    }
    field.appendChild(hint);
  }
  form.appendChild(field);
}

function renderSelect(d){
  const form = getOrCreateForm();
  const field = document.createElement('div');
  field.className = 'field';
  field.innerHTML = `<label>${d.label}</label>`;
  const sel = document.createElement('select');
  sel.dataset.name = d.name;
  sel.id = 'field_'+d.name;
  d.options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.value; opt.textContent = o.label;
    if(o.value === d.value) opt.selected = true;
    sel.appendChild(opt);
  });
  field.appendChild(sel);
  form.appendChild(field);
}

function renderCode(d){
  const pre = document.createElement('div');
  pre.className = 'w-code';
  pre.textContent = d.text;
  widgets.appendChild(pre);
}

function renderStatus(d){
  const wrap = document.createElement('div');
  wrap.className = 'w-status';
  d.items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'status-item';
    row.innerHTML = `<div class="status-dot ${item.ok?'ok':'err'}"></div>
      <span class="status-name">${item.name}</span>
      <span class="status-detail">${item.detail||''}</span>`;
    wrap.appendChild(row);
  });
  widgets.appendChild(wrap);
}

function renderProgress(d){
  // Progress goes to processes panel, not #widgets â€” upsert by slug key
  const key = 'proc-' + d.label.replace(/[^a-z0-9]/gi,'_');
  let item = processesList.querySelector(`[data-proc="${key}"]`);
  if (!item) {
    item = document.createElement('div');
    item.className = 'process-item';
    item.setAttribute('data-proc', key);
    processesList.appendChild(item);
  }
  const statusClass = d.done ? 'running' : d.error ? 'stopped' : 'unknown';
  const icon = d.done ? 'âœ…' : d.error ? 'âŒ' : 'â³';
  item.innerHTML = `
    <div class="process-status ${statusClass}"></div>
    <span class="process-name">${icon} ${d.label}</span>`;
  processesList.scrollTop = processesList.scrollHeight;
}

// â”€â”€ Panel resizing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const resizeHandleChat = document.getElementById('resize-handle-chat');
const resizeHandleLogs = document.getElementById('resize-handle-logs');
const chatPanel = document.getElementById('chat-panel');
const processesPanel = document.getElementById('processes-panel');
const logPanel = document.getElementById('log-panel');
const mainContainer = document.querySelector('.main');
let isResizing = false;
let activeHandle = null;
let startX = 0;
let startWidths = {};

function setupResizeHandle(handle, leftPanel, rightPanel) {
  handle.addEventListener('mousedown', (e) => {
    isResizing = true;
    activeHandle = handle;
    startX = e.clientX;
    startWidths = {
      left: leftPanel.offsetWidth,
      right: rightPanel.offsetWidth
    };
    
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    document.body.style.pointerEvents = 'none';
    handle.style.pointerEvents = 'auto';
    e.preventDefault();
  });
}

setupResizeHandle(resizeHandleChat, chatPanel, processesPanel);
setupResizeHandle(resizeHandleLogs, processesPanel, logPanel);

document.addEventListener('mousemove', (e) => {
  if (!isResizing || !activeHandle) return;
  
  const deltaX = e.clientX - startX;
  const containerWidth = mainContainer.offsetWidth;
  const minPanelWidth = 200;
  
  if (activeHandle === resizeHandleChat) {
    // Resize between chat and processes
    const newChatWidth = startWidths.left + deltaX;
    const newProcessesWidth = startWidths.right - deltaX;
    
    if (newChatWidth >= minPanelWidth && newProcessesWidth >= minPanelWidth) {
      chatPanel.style.width = newChatWidth + 'px';
      processesPanel.style.width = newProcessesWidth + 'px';
    }
  } else if (activeHandle === resizeHandleLogs) {
    // Resize between processes and logs
    const newProcessesWidth = startWidths.left + deltaX;
    const newLogWidth = startWidths.right - deltaX;
    
    if (newProcessesWidth >= minPanelWidth && newLogWidth >= minPanelWidth) {
      processesPanel.style.width = newProcessesWidth + 'px';
      logPanel.style.width = newLogWidth + 'px';
    }
  }
});

document.addEventListener('mouseup', () => {
  if (isResizing) {
    isResizing = false;
    activeHandle = null;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    document.body.style.pointerEvents = '';
    
    // Save panel widths
    localStorage.setItem('dockfra-chat-width', chatPanel.offsetWidth);
    localStorage.setItem('dockfra-processes-width', processesPanel.offsetWidth);
    localStorage.setItem('dockfra-log-width', logPanel.offsetWidth);
  }
});

// Restore saved widths on page load
function restorePanelWidths() {
  const containerWidth = mainContainer.offsetWidth;
  const savedChatWidth = localStorage.getItem('dockfra-chat-width');
  const savedProcessesWidth = localStorage.getItem('dockfra-processes-width');
  const savedLogWidth = localStorage.getItem('dockfra-log-width');
  
  if (savedChatWidth && savedProcessesWidth && savedLogWidth) {
    chatPanel.style.width = savedChatWidth + 'px';
    processesPanel.style.width = savedProcessesWidth + 'px';
    logPanel.style.width = savedLogWidth + 'px';
  } else {
    // Default split: 25% chat, 20% processes, 55% logs
    chatPanel.style.width = '25%';
    processesPanel.style.width = '20%';
    logPanel.style.width = '55%';
  }
}

// Restore widths after page load
setTimeout(restorePanelWidths, 100);

// â”€â”€ Processes panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateProcesses() {
  try {
    const response = await fetch('/api/processes');
    const processes = await response.json();
    
    processesList.innerHTML = '';
    
    processes.forEach(process => {
      const item = document.createElement('div');
      item.className = 'process-item';
      
      const statusClass = process.status === 'running' ? 'running' : 
                         process.status === 'stopped' ? 'stopped' : 'unknown';
      
      // Create icon buttons for process actions
      const actionsContainer = document.createElement('div');
      actionsContainer.className = 'process-actions';
      
      // Stop button
      const stopBtn = document.createElement('button');
      stopBtn.className = 'process-icon-btn';
      stopBtn.innerHTML = 'â¹<span class="tooltip">Stop</span>';
      stopBtn.onclick = async () => {
        await executeProcessAction('stop', process.name);
        setTimeout(updateProcesses, 2000);
      };
      
      // Restart button
      const restartBtn = document.createElement('button');
      restartBtn.className = 'process-icon-btn';
      restartBtn.innerHTML = 'ğŸ”„<span class="tooltip">Restart</span>';
      restartBtn.onclick = async () => {
        await executeProcessAction('restart', process.name);
        setTimeout(updateProcesses, 2000);
      };
      
      // Change port button
      const portBtn = document.createElement('button');
      portBtn.className = 'process-icon-btn';
      portBtn.innerHTML = 'ğŸ”§<span class="tooltip">Change Port</span>';
      portBtn.onclick = async () => {
        const newPort = prompt(`Enter new port for ${process.name}:`);
        if (newPort) {
          await executeProcessAction('change_port', process.name, { port: newPort });
          setTimeout(updateProcesses, 2000);
        }
      };
      
      actionsContainer.appendChild(stopBtn);
      actionsContainer.appendChild(restartBtn);
      actionsContainer.appendChild(portBtn);
      
      item.innerHTML = `
        <div class="process-status ${statusClass}"></div>
        <span class="process-name">${process.name}</span>
        <span class="process-details">${process.details}</span>
      `;
      
      // Add actions buttons
      if (process.type === 'container') {
        item.appendChild(actionsContainer);
      }
      
      processesList.appendChild(item);
    });
    
    if (processes.length === 0) {
      processesList.innerHTML = '<div style="color:var(--muted);font-size:.7rem;">No processes found</div>';
    }
  } catch (error) {
    processesList.innerHTML = '<div style="color:var(--red);font-size:.7rem;">Error loading processes</div>';
  }
}

// Execute process action
async function executeProcessAction(action, processName, data = {}) {
  try {
    const response = await fetch(`/api/process/${action}/${processName}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log(`Successfully ${action} ${processName}`);
    } else {
      console.error(`Failed to ${action} ${processName}:`, result.message);
      alert(`Failed to ${action} ${processName}: ${result.message}`);
    }
  } catch (error) {
    console.error(`Error executing ${action} on ${processName}:`, error);
    alert(`Error executing ${action} on ${processName}: ${error.message}`);
  }
}

// Update processes every 5 seconds
setInterval(updateProcesses, 5000);
updateProcesses(); // Initial load

// â”€â”€ Copy logs functionality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('copy-logs').addEventListener('click', () => {
  const allLogs = Array.from(logOut.children).map(child => child.textContent).join('\n');
  const truncatedLogs = allLogs.length > 5000 ? allLogs.slice(-5000) : allLogs;
  
  navigator.clipboard.writeText(truncatedLogs).then(() => {
    const btn = document.getElementById('copy-logs');
    const originalText = btn.textContent;
    btn.textContent = 'âœ… Copied!';
    btn.style.background = 'var(--accent)';
    btn.style.color = '#fff';
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = 'var(--bg3)';
      btn.style.color = 'var(--text)';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy logs:', err);
    const btn = document.getElementById('copy-logs');
    btn.textContent = 'âŒ Failed';
    setTimeout(() => {
      btn.textContent = 'ğŸ“‹ Copy';
    }, 2000);
  });
});

// â”€â”€ Copy chat functionality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('copy-chat').addEventListener('click', () => {
  const allMessages = Array.from(chat.children).map(msgDiv => {
    const role = msgDiv.classList.contains('bot') ? 'ğŸ¤– Bot' : 'ğŸ‘¤ User';
    const bubble = msgDiv.querySelector('.bubble');
    const content = bubble ? bubble.textContent || bubble.innerText : '';
    return `${role}: ${content}`;
  }).join('\n\n');
  
  navigator.clipboard.writeText(allMessages).then(() => {
    const btn = document.getElementById('copy-chat');
    const originalText = btn.textContent;
    btn.textContent = 'âœ… Copied!';
    btn.style.background = 'var(--accent)';
    btn.style.color = '#fff';
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = 'var(--bg3)';
      btn.style.color = 'var(--text)';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy chat:', err);
    const btn = document.getElementById('copy-chat');
    btn.textContent = 'âŒ Failed';
    setTimeout(() => {
      btn.textContent = 'ğŸ“‹ Copy';
    }, 2000);
  });
});

// â”€â”€ Copy processes functionality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('copy-processes').addEventListener('click', () => {
  const allProcesses = Array.from(processesList.children).map(processDiv => {
    const statusEl = processDiv.querySelector('.process-status');
    const nameEl = processDiv.querySelector('.process-name');
    const detailsEl = processDiv.querySelector('.process-details');
    
    const status = statusEl ? (
      statusEl.classList.contains('running') ? 'ğŸŸ¢ Running' :
      statusEl.classList.contains('stopped') ? 'ğŸ”´ Stopped' : 'âšª Unknown'
    ) : 'âšª Unknown';
    
    const name = nameEl ? nameEl.textContent : 'Unknown';
    const details = detailsEl ? detailsEl.textContent : '';
    
    return `${status} | ${name} | ${details}`;
  }).join('\n');
  
  navigator.clipboard.writeText(allProcesses).then(() => {
    const btn = document.getElementById('copy-processes');
    const originalText = btn.textContent;
    btn.textContent = 'âœ… Copied!';
    btn.style.background = 'var(--accent)';
    btn.style.color = '#fff';
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = 'var(--bg3)';
      btn.style.color = 'var(--text)';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy processes:', err);
    const btn = document.getElementById('copy-processes');
    btn.textContent = 'âŒ Failed';
    setTimeout(() => {
      btn.textContent = 'ğŸ“‹ Copy';
    }, 2000);
  });
});

// â”€â”€ Log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('log_line', d => {
  // Check if log line already exists to prevent duplicates
  if (d.id) {
    const existingLog = document.querySelector(`[data-log-id="${d.id}"]`);
    if (existingLog) return; // Skip duplicate
  }
  
  const l = document.createElement('div');
  l.className = 'log-line' + (d.text.includes('Error')||d.text.includes('error')||d.text.startsWith('E ')?' err':'');
  if (d.id) l.setAttribute('data-log-id', d.id);
  l.textContent = d.text;
  logOut.appendChild(l);
  logOut.scrollTop = logOut.scrollHeight;
  // keep last 500 lines
  while(logOut.children.length > 500) logOut.removeChild(logOut.firstChild);
});
</script>
</body>
</html>
