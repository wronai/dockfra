# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ssh-monitor â€” Deploy & Health Orchestrator
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Run from repo root:  make -f management/ssh-monitor/Makefile <target>
# Or: cd management/ssh-monitor && make <target>
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONTAINER  ?= dockfra-ssh-monitor
USER       ?= monitor
SSH_PORT   ?= 2201
SSH        := ssh $(USER)@localhost -p $(SSH_PORT) -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
EXEC       := docker exec -it -u $(USER) $(CONTAINER) bash -lc

.DEFAULT_GOAL := help

.PHONY: help
help: ## Show available commands
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘              ğŸ“¡ MONITOR â€” Deploy & Health Orchestrator       â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  make shell           â€” Interactive SSH session              â•‘"
	@echo "â•‘                                                              â•‘"
	@echo "â•‘  Deploy:                                                     â•‘"
	@echo "â•‘    make status                                               â•‘"
	@echo "â•‘    make deploy-all                                           â•‘"
	@echo "â•‘    make deploy-backend                                       â•‘"
	@echo "â•‘    make deploy-frontend                                      â•‘"
	@echo "â•‘    make deploy-rpi3                                          â•‘"
	@echo "â•‘    make verify                                               â•‘"
	@echo "â•‘                                                              â•‘"
	@echo "â•‘  AI Analysis:                                                â•‘"
	@echo "â•‘    make analyze-logs                                         â•‘"
	@echo "â•‘    make ask Q=\"Why is the backend slow?\"                    â•‘"
	@echo "â•‘                                                              â•‘"
	@echo "â•‘  Daemon:                                                     â•‘"
	@echo "â•‘    make monitor-log   â€” Watch auto-deploy daemon log         â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""

.PHONY: shell
shell: ## Open interactive SSH session
	@$(SSH)

.PHONY: status
status: ## Full infrastructure status
	@$(EXEC) "status"

.PHONY: deploy-all
deploy-all: ## Deploy to all targets via SSH
	@$(EXEC) "deploy-all"

.PHONY: deploy-backend
deploy-backend: ## Deploy backend only
	@$(EXEC) "deploy-backend"

.PHONY: deploy-frontend
deploy-frontend: ## Deploy frontend only
	@$(EXEC) "deploy-frontend"

.PHONY: deploy-rpi3
deploy-rpi3: ## Deploy to RPi3
	@$(EXEC) "deploy-rpi3"

.PHONY: verify
verify: ## Post-deploy health check
	@$(EXEC) "verify"

.PHONY: analyze-logs
analyze-logs: ## AI analysis of recent logs
	@$(EXEC) "analyze-logs"

.PHONY: ask
ask: ## Ask LLM about infrastructure: make ask Q="Why is the backend slow?"
	@[ -n "$(Q)" ] || (echo "Usage: make ask Q=\"your question\"" && exit 1)
	@$(EXEC) "ask $(Q)"

.PHONY: monitor-log
monitor-log: ## Watch auto-deploy daemon log (live)
	@$(EXEC) "tail -f /var/log/monitor-daemon.log"

.PHONY: logs
logs: ## Tail monitor container logs
	@docker logs -f $(CONTAINER)
